apiVersion: v1
kind: Pod
metadata:
  name: wikipedia-server
  namespace: default
  labels:
    app: wikipedia
spec:
  volumes:
    - name: shared-html
      emptyDir: {}

  initContainers:
    - name: wiki-fetcher-init
      image: curlimages/curl:latest
      command:
        - sh
        - -c
        - |
          echo "Init container: Fetching Kubernetes Wikipedia page..."
          curl -L -o /usr/share/nginx/html/index.html \
            "https://en.wikipedia.org/wiki/Kubernetes"
          echo "Init container: Page fetched successfully"
          ls -lh /usr/share/nginx/html/
      volumeMounts:
        - name: shared-html
          mountPath: /usr/share/nginx/html

  containers:
    - name: nginx
      image: nginx:alpine
      ports:
        - containerPort: 80
      volumeMounts:
        - name: shared-html
          mountPath: /usr/share/nginx/html
      readinessProbe:
        httpGet:
          path: /
          port: 80
        initialDelaySeconds: 2
        periodSeconds: 5

    - name: wiki-updater-sidecar
      image: curlimages/curl:latest
      command:
        - sh
        - -c
        - |
          echo "Sidecar: Starting random Wikipedia page updater..."
          while true; do
            # Random sleep between 5 and 15 minutes (300-900 seconds)
            SLEEP_TIME=$((300 + RANDOM % 600))
            echo "Sidecar: Sleeping for $SLEEP_TIME seconds..."
            sleep $SLEEP_TIME

            echo "Sidecar: Fetching random Wikipedia page..."
            curl -L -o /usr/share/nginx/html/index.html \
              "https://en.wikipedia.org/wiki/Special:Random"
            echo "Sidecar: Random page updated at $(date)"
            ls -lh /usr/share/nginx/html/
          done
      volumeMounts:
        - name: shared-html
          mountPath: /usr/share/nginx/html

---

apiVersion: v1
kind: Service
metadata:
  name: wikipedia-svc
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: wikipedia
  ports:
    - port: 80
      targetPort: 80
